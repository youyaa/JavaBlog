## 什么是一致性

对于一个分布式系统，不能同时满足以下三点

## CAP原则

- 一致性（Consistency）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）
- 可用性（Availability）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性）
- 分区容错性（Partition tolerance）： 以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。

> ZK 是不是就是严格实现了 CP ，而 Eureka 则是保证了 AP。（待理解）

## 一致性模型

### 弱一致性（最终一致性）

1. DNS （Domain Name System）域名解析系统 
2. Gossip（流言）算法

### 强一致性

1. 主从同步（所有从节点返回成功后，才返回给客户端响应，可用性太低）
2. Paxos       （多数派：大部分节点都返回成功后就给客户端响应）
3. Raft
4. ZAB

## Paxos协议

Paxos用于解决分布式系统中一致性问题。分布式一致性算法（Consensus Algorithm）是一个分布式计算领域的基础性问题，其最基本的功能是为了在多个进程之间对某个（某些）值达成一致（强一致）；简单来说就是确定一个值，一旦被写入就不可改变。paxos用来实现多节点写入来完成一件事情，例如mysql主从也是一种方案，但这种方案有个致命的缺陷，如果主库挂了会直接影响业务，导致业务不可写，从而影响整个系统的高可用性。paxos协议是只是一个协议，不是具体的一套解决方案。目的是解决多节点写入问题。

> 总结：将所有节点都写入同一个值，且被写入后不再更改。这里的“值”并不是狭义上的一个数值，可以是一条命令，或者其他的。

### Basic Paxos

#### 角色

1. Client   系统外部角色，请求发起者。
2. Proposer   接受Client请求，发起Propose，并调节冲突。
3. Acceptor   提议投票和接受者。
4. Learner    提议接受者，备份，不参与投票。

#### 步骤和阶段

1. Prepare阶段

   Proposer提出一个提案，编号为N，N为大于这个Proposer之前提出的提案编号，请求Acceptor的quorum接收。

2. Promise阶段

   如果N大于此acceptor之前接收的任何提案编号则接受，否则拒绝。

3. Accept阶段

   如果达到了多数派，Proposer会发出accept请求，此请求包含提案编号N，以及内容。

4. Accepted阶段

   如果



### Multi Paxos

### Fast Paxos



## Base理论

BASE是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的缩写。BASE理论是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结， 是基于CAP定理逐步演化而来的。BASE理论的核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。接下来看一下BASE中的三要素：

#### 基本可用

基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。这绝不等价于系统不可用。比如： 

1. 响应时间上的损失。正常情况下，一个在线搜索引擎需要在0.5秒之内返回给用户相应的查询结果，但由于出现故障，查询结果的响应时间增加了1~2秒 

2. 系统功能上的损失：正常情况下，在一个电子商务网站上进行购物的时候，消费者几乎能够顺利完成每一笔订单，但是在一些节日大促购物高峰的时候，由于消费者的购物行为激增，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面

#### 软状态

软状态指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时

#### 最终一致性

最终一致性强调的是所有的数据副本，在经过一段时间的同步之后，最终都能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。